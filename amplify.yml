version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ğŸš€ Iniciando preBuild do AI Crypto Trading..."
        - echo "ğŸ“¦ VersÃ£o do Node.js:" && node --version
        - echo "ğŸ“¦ VersÃ£o do npm:" && npm --version
        
        # Configurar Git de forma segura
        - echo "ğŸ”§ Configurando Git..."
        - git config --global user.email "build@amplify.com" || echo "Git config falhou, continuando..."
        - git config --global user.name "Amplify Build" || echo "Git config falhou, continuando..."
        
        # Instalar Bun globalmente
        - echo "ğŸ“¦ Instalando Bun..."
        - npm install -g bun || (echo "âš ï¸ Falha ao instalar Bun, usando npm..." && export USE_NPM=true)
        
        # Verificar variÃ¡veis de ambiente essenciais
        - echo "ğŸ” Verificando variÃ¡veis de ambiente..."
        - |
          if [ -z "$DATABASE_URL" ]; then
            echo "âš ï¸ AVISO: DATABASE_URL nÃ£o configurada - usando modo mock"
            export DATABASE_URL="file:./dev.db"
          else
            echo "âœ… DATABASE_URL configurada"
          fi
        - |
          if [ -z "$NEXTAUTH_SECRET" ]; then
            echo "âš ï¸ AVISO: NEXTAUTH_SECRET nÃ£o configurada - gerando temporÃ¡ria"
            export NEXTAUTH_SECRET="amplify-build-temp-secret-$(date +%s)"
          else
            echo "âœ… NEXTAUTH_SECRET configurada"
          fi
        - |
          if [ -z "$NEXT_PUBLIC_BINANCE_API_KEY" ]; then
            echo "âš ï¸ AVISO: NEXT_PUBLIC_BINANCE_API_KEY nÃ£o configurada"
            export NEXT_PUBLIC_BINANCE_API_KEY="demo-key"
          else
            echo "âœ… NEXT_PUBLIC_BINANCE_API_KEY configurada"
          fi
        
        # Gerar Prisma Client se possÃ­vel
        - echo "ğŸ—„ï¸ Configurando Prisma..."
        - |
          if [ -f "prisma/schema.prisma" ]; then
            echo "ğŸ“„ Schema Prisma encontrado, gerando client..."
            npx prisma generate || echo "âš ï¸ Falha ao gerar Prisma Client - usando mock"
          else
            echo "â„¹ï¸ Schema Prisma nÃ£o encontrado - usando configuraÃ§Ã£o mock"
          fi
        
        # Instalar dependÃªncias
        - echo "ğŸ“¦ Instalando dependÃªncias..."
        - |
          if [ "$USE_NPM" = "true" ]; then
            npm ci
          else
            bun install --frozen-lockfile || npm ci
          fi
        
        - echo "ğŸ“ Gerando arquivo .env.production a partir das variÃ¡veis de ambiente do Amplify"
        # Exporta variÃ¡veis privadas e pÃºblicas que devem estar disponÃ­veis em runtime (SSR e API Routes)
        - |
          env | grep -E '^(DATABASE_URL|NEXTAUTH_URL|NEXTAUTH_SECRET|JWT_SECRET|MAILERSEND_API_TOKEN|ADMIN_EMAIL|BINANCE_API_KEY|BINANCE_API_SECRET|NEXT_PUBLIC_)' >> .env.production
        - echo "ğŸ“„ ConteÃºdo final de .env.production:"
        - cat .env.production
        
        - echo "âœ… preBuild concluÃ­do com sucesso!"
        
    build:
      commands:
        - echo "ğŸ—ï¸ Iniciando build do Next.js..."
        
        # Verificar versÃµes
        - echo "ğŸ“¦ Verificando ambiente de build..."
        - npx next --version || echo "Next.js nÃ£o encontrado"
        - echo "ğŸ”§ Node.js:" && node --version
        
        # ConfiguraÃ§Ãµes de otimizaÃ§Ã£o
        - echo "âš™ï¸ Configurando otimizaÃ§Ãµes..."
        - export NODE_OPTIONS="--max-old-space-size=4096"
        - export NEXT_TELEMETRY_DISABLED=1
        
        # Build da aplicaÃ§Ã£o
        - echo "ğŸ—ï¸ Executando build..."
        - |
          if [ "$USE_NPM" = "true" ]; then
            npm run build
          else
            bun run build || npm run build
          fi
        
        # Verificar se o build foi bem-sucedido
        - echo "âœ… Verificando resultado do build..."
        - |
          if [ ! -d ".next" ]; then
            echo "âŒ ERRO: Build falhou - diretÃ³rio .next nÃ£o encontrado"
            ls -la
            exit 1
          fi
        - |
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ ERRO: Build incompleto - BUILD_ID nÃ£o encontrado"
            ls -la .next/
            exit 1
          fi
        
        - echo "âœ… Build concluÃ­do com sucesso!"
        - echo "ğŸ“Š EstatÃ­sticas do build:"
        - du -sh .next/
        - echo "ğŸ“ Arquivos gerados:"
        - find .next -name "*.js" -o -name "*.css" | head -10
        
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.bun/install/cache/**/*
