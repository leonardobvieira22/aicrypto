version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸš€ Iniciando preBuild do AI Crypto Trading..."
        - echo "ðŸ“¦ VersÃ£o do Node.js:" && node --version
        - echo "ðŸ“¦ VersÃ£o do npm:" && npm --version
        
        # Configurar Git de forma segura
        - echo "ðŸ”§ Configurando Git..."
        - git config --global user.email "build@amplify.com" || echo "Git config falhou, continuando..."
        - git config --global user.name "Amplify Build" || echo "Git config falhou, continuando..."
        
        # Instalar Bun globalmente
        - echo "ðŸ“¦ Instalando Bun..."
        - npm install -g bun || (echo "âš ï¸ Falha ao instalar Bun, usando npm..." && export USE_NPM=true)
        
        # Verificar e validar variÃ¡veis de ambiente essenciais
        - echo "ðŸ” Verificando variÃ¡veis de ambiente..."
        - |
          echo "=== VERIFICAÃ‡ÃƒO DE VARIÃVEIS DE AMBIENTE ==="
          echo "DATABASE_URL: ${DATABASE_URL:0:20}..." # Mostra apenas os primeiros 20 caracteres por seguranÃ§a
          echo "NEXTAUTH_URL: $NEXTAUTH_URL"
          echo "NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:0:10}..." # Mostra apenas os primeiros 10 caracteres
          echo "ADMIN_EMAIL: $ADMIN_EMAIL"
          echo "NEXT_PUBLIC_BINANCE_API_KEY: ${NEXT_PUBLIC_BINANCE_API_KEY:0:10}..."
          echo "MAILERSEND_API_TOKEN: ${MAILERSEND_API_TOKEN:0:10}..."
          echo "JWT_SECRET: ${JWT_SECRET:0:10}..."
          echo "============================================="
        
        # Configurar NEXTAUTH_URL automaticamente se nÃ£o estiver definida
        - |
          if [ -z "$NEXTAUTH_URL" ]; then
            echo "âš ï¸ NEXTAUTH_URL nÃ£o configurada, configurando automaticamente..."
            # Obter a URL do Amplify automaticamente
            if [ ! -z "$AWS_APP_ID" ]; then
              export NEXTAUTH_URL="https://$AWS_BRANCH_NAME.$AWS_APP_ID.amplifyapp.com"
              echo "âœ… NEXTAUTH_URL configurada como: $NEXTAUTH_URL"
            else
              echo "âŒ ERRO: NÃ£o foi possÃ­vel configurar NEXTAUTH_URL automaticamente"
              export NEXTAUTH_URL="https://main.d34l4lklofiz4e.amplifyapp.com"
              echo "âš ï¸ Usando NEXTAUTH_URL padrÃ£o: $NEXTAUTH_URL"
            fi
          else
            echo "âœ… NEXTAUTH_URL jÃ¡ configurada: $NEXTAUTH_URL"
          fi
        
        # ValidaÃ§Ã£o obrigatÃ³ria das variÃ¡veis crÃ­ticas
        - |
          if [ -z "$DATABASE_URL" ]; then
            echo "âŒ ERRO CRÃTICO: DATABASE_URL nÃ£o configurada"
            exit 1
          else
            echo "âœ… DATABASE_URL configurada"
          fi
        - |
          if [ -z "$NEXTAUTH_SECRET" ]; then
            echo "âŒ ERRO CRÃTICO: NEXTAUTH_SECRET nÃ£o configurada"
            exit 1
          else
            echo "âœ… NEXTAUTH_SECRET configurada"
          fi
        - |
          if [ -z "$JWT_SECRET" ]; then
            echo "âŒ ERRO CRÃTICO: JWT_SECRET nÃ£o configurada"
            exit 1
          else
            echo "âœ… JWT_SECRET configurada"
          fi
        
        # Criar arquivo .env.production com todas as variÃ¡veis necessÃ¡rias
        - echo "ðŸ“ Criando arquivo .env.production..."
        - |
          cat > .env.production << EOF
          # ConfiguraÃ§Ã£o de ProduÃ§Ã£o - AWS Amplify
          NODE_ENV=production
          
          # Banco de Dados
          DATABASE_URL=$DATABASE_URL
          
          # NextAuth.js
          NEXTAUTH_URL=$NEXTAUTH_URL
          NEXTAUTH_SECRET=$NEXTAUTH_SECRET
          
          # JWT
          JWT_SECRET=$JWT_SECRET
          
          # Email
          MAILERSEND_API_TOKEN=$MAILERSEND_API_TOKEN
          ADMIN_EMAIL=$ADMIN_EMAIL
          
          # Binance API
          NEXT_PUBLIC_BINANCE_API_KEY=$NEXT_PUBLIC_BINANCE_API_KEY
          BINANCE_API_SECRET=$BINANCE_API_SECRET
          
          # URLs PÃºblicas
          NEXT_PUBLIC_APP_URL=$NEXTAUTH_URL
          
          # Build Config
          NEXT_TELEMETRY_DISABLED=1
          AWS_AMPLIFY_BUILD=true
          NEXT_PHASE=phase-production-build
          EOF
        
        - echo "ðŸ“„ ConteÃºdo de .env.production criado:"
        - cat .env.production
        
        # Instalar dependÃªncias
        - echo "ðŸ“¦ Instalando dependÃªncias..."
        - |
          if [ "$USE_NPM" = "true" ]; then
            npm ci --production=false
          else
            bun install --frozen-lockfile || npm ci --production=false
          fi
        
        # Gerar Prisma Client para produÃ§Ã£o
        - echo "ðŸ—„ï¸ Configurando Prisma para produÃ§Ã£o..."
        - |
          echo "Gerando Prisma Client..."
          npx prisma generate || {
            echo "âŒ Erro ao gerar Prisma Client"
            exit 1
          }
          echo "âœ… Prisma Client gerado com sucesso"
        
        - echo "âœ… preBuild concluÃ­do com sucesso!"
        
    build:
      commands:
        - echo "ðŸ—ï¸ Iniciando build do Next.js..."
        
        # Verificar versÃµes
        - echo "ðŸ“¦ Verificando ambiente de build..."
        - npx next --version || echo "Next.js nÃ£o encontrado"
        - echo "ðŸ”§ Node.js:" && node --version
        
        # ConfiguraÃ§Ãµes de otimizaÃ§Ã£o para AWS Lambda
        - echo "âš™ï¸ Configurando otimizaÃ§Ãµes para AWS Lambda..."
        - export NODE_OPTIONS="--max-old-space-size=4096"
        - export NEXT_TELEMETRY_DISABLED=1
        - export AWS_AMPLIFY_BUILD=true
        - export NEXT_PHASE=phase-production-build
        
        # Verificar se o arquivo .env.production existe
        - |
          if [ ! -f ".env.production" ]; then
            echo "âŒ ERRO: Arquivo .env.production nÃ£o encontrado"
            exit 1
          fi
        
        # Build da aplicaÃ§Ã£o
        - echo "ðŸ—ï¸ Executando build do Next.js..."
        - |
          if [ "$USE_NPM" = "true" ]; then
            npm run build
          else
            bun run build || npm run build
          fi
        
        # Verificar se o build foi bem-sucedido
        - echo "âœ… Verificando resultado do build..."
        - |
          if [ ! -d ".next" ]; then
            echo "âŒ ERRO: Build falhou - diretÃ³rio .next nÃ£o encontrado"
            ls -la
            exit 1
          fi
        - |
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ ERRO: Build incompleto - BUILD_ID nÃ£o encontrado"
            ls -la .next/
            exit 1
          fi
        
        - echo "âœ… Build concluÃ­do com sucesso!"
        - echo "ðŸ“Š EstatÃ­sticas do build:"
        - du -sh .next/
        - echo "ðŸ“ Arquivos gerados:"
        - find .next -name "*.js" -o -name "*.css" | head -10
        
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.bun/install/cache/**/*
