version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "üöÄ Iniciando preBuild do AI Crypto Trading..."
        - echo "üì¶ Vers√£o do Node.js:" && node --version
        - echo "üì¶ Vers√£o do npm:" && npm --version
        
        # Configurar Git de forma segura
        - echo "üîß Configurando Git..."
        - git config --global user.email "build@amplify.com" || echo "Git config falhou, continuando..."
        - git config --global user.name "Amplify Build" || echo "Git config falhou, continuando..."
        
        # Instalar Bun globalmente
        - echo "üì¶ Instalando Bun..."
        - npm install -g bun || (echo "‚ö†Ô∏è Falha ao instalar Bun, usando npm..." && export USE_NPM=true)
        
        # Verificar vari√°veis de ambiente essenciais
        - echo "üîê Verificando vari√°veis de ambiente..."
        - |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ö†Ô∏è AVISO: DATABASE_URL n√£o configurada - usando modo mock"
            export DATABASE_URL="file:./dev.db"
          else
            echo "‚úÖ DATABASE_URL configurada"
          fi
        - |
          if [ -z "$NEXTAUTH_SECRET" ]; then
            echo "‚ö†Ô∏è AVISO: NEXTAUTH_SECRET n√£o configurada - gerando tempor√°ria"
            export NEXTAUTH_SECRET="amplify-build-temp-secret-$(date +%s)"
          else
            echo "‚úÖ NEXTAUTH_SECRET configurada"
          fi
        - |
          if [ -z "$NEXT_PUBLIC_BINANCE_API_KEY" ]; then
            echo "‚ö†Ô∏è AVISO: NEXT_PUBLIC_BINANCE_API_KEY n√£o configurada"
            export NEXT_PUBLIC_BINANCE_API_KEY="demo-key"
          else
            echo "‚úÖ NEXT_PUBLIC_BINANCE_API_KEY configurada"
          fi
        
        # Gerar Prisma Client se poss√≠vel
        - echo "üóÑÔ∏è Configurando Prisma..."
        - |
          if [ -f "prisma/schema.prisma" ]; then
            echo "üìÑ Schema Prisma encontrado, gerando client..."
            npx prisma generate || echo "‚ö†Ô∏è Falha ao gerar Prisma Client - usando mock"
          else
            echo "‚ÑπÔ∏è Schema Prisma n√£o encontrado - usando configura√ß√£o mock"
          fi
        
        # Instalar depend√™ncias
        - echo "üì¶ Instalando depend√™ncias..."
        - |
          if [ "$USE_NPM" = "true" ]; then
            npm ci
          else
            bun install --frozen-lockfile || npm ci
          fi
        
        - echo "‚úÖ preBuild conclu√≠do com sucesso!"
        
    build:
      commands:
        - echo "üèóÔ∏è Iniciando build do Next.js..."
        
        # Verificar vers√µes
        - echo "üì¶ Verificando ambiente de build..."
        - npx next --version || echo "Next.js n√£o encontrado"
        - echo "üîß Node.js:" && node --version
        
        # Configura√ß√µes de otimiza√ß√£o
        - echo "‚öôÔ∏è Configurando otimiza√ß√µes..."
        - export NODE_OPTIONS="--max-old-space-size=4096"
        - export NEXT_TELEMETRY_DISABLED=1
        
        # Build da aplica√ß√£o
        - echo "üèóÔ∏è Executando build..."
        - |
          if [ "$USE_NPM" = "true" ]; then
            npm run build
          else
            bun run build || npm run build
          fi
        
        # Verificar se o build foi bem-sucedido
        - echo "‚úÖ Verificando resultado do build..."
        - |
          if [ ! -d ".next" ]; then
            echo "‚ùå ERRO: Build falhou - diret√≥rio .next n√£o encontrado"
            ls -la
            exit 1
          fi
        - |
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "‚ùå ERRO: Build incompleto - BUILD_ID n√£o encontrado"
            ls -la .next/
            exit 1
          fi
        
        - echo "‚úÖ Build conclu√≠do com sucesso!"
        - echo "üìä Estat√≠sticas do build:"
        - du -sh .next/
        - echo "üìÅ Arquivos gerados:"
        - find .next -name "*.js" -o -name "*.css" | head -10
        
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.bun/install/cache/**/*
